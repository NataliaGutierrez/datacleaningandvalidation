---
title: "Pràctica 2: Neteja i validació de les dades"
author: "Natalia Gutierrez Navarro"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output: 
  pdf_document:
    toc: yes
    number_sections: yes
bibliography: scholar.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(knitr)
library(lattice)
library(VIM)
```

# Descripció del dataset

El conjunt de dades en qüestió té relació amb la variant de vi negre portuguès "Vinho Verde" i ha sigut extret directament de *Kaggle* (https://www.kaggle.com/uciml/red-wine-quality-cortez-et-al-2009). Està constituït per 1599 registres amb 12 variables, de les quals 11 fan referència a propietats fisicoquímiques i una a la valoració sensorial de la qualitat. Aquestes són [@Cortez:2009][@Atenea:2012]:

* **fixed acidity**: és l'acidesa d'un vi relativa a la suma de la quantitat d'àcids fixos que es troben en la seva composició, majoritàriament el tartàric. Una quantitat òptima és de 7.5 gr/litre [gr/l].

* **volatile acidity**: és la concentracíó d'àcid acètic i derivats [gr/l].

* **citric acid**: concentració d'àcid cítric. Al vi es troba en quantitats que normalment oscil·len entre 100 i 300 mg/litre  [gr/l].

* **residual sugar**: principalment glucosa i fructosa que no s'han fermentat. Depenent de la seva quantitat, es categoritza el vi com sec (4-9g/l), semisec (12-18g/l), semidolç (<45 g/l) o dolç (>45g/l). Els valors dins dels rangs depenen de l'acidesa total  [gr/l].

* **chlorides**: concentració de clorurs, algunes de les sals minerals que hi han al vi en petites quantitats (el total de totes les sals és 2-4 g/l) [g/l].

* **free sulfur dioxide**: anhídrid sulfuròs que no es troba combinat amb altres components, i per tant, és el que proporciona les propietats antisèptiques [mg/l].

* **total sulfur dioxide**: el total d' anhídrid sulfuròs, lliure i combinat, és un conservant afegit . El límit legal és 250mg/l; per vins de qualitat, 200 mg/l [mg/l].

* **density**: en g/cm3.

* **pH**: mesura la concentració d'ions H+.

* **sulphates**: concentració de sulfats, algunes de les sals minerals que hi han al vi en petites quantitats (el total de totes les sals és 2-4 g/l) [g/l].

* **alcohol**: quantitat d'alcohol, el qual serà etanol principalment. Es mesura en graus i el seu valor indica el volum en que es troba, expressat en percentatge, com en aquest cas.

* **quality**: puntuació mitja proporcionada per catadors dins del rang [0,10].

# Objectius de l'anàlisi

A partir del conjunt de dades disponible, en aquest anàlisi es planteja la possibilitat de poder predir la qualitat del vi des del punt de vista sensorial fent servir les seves propietats fisicoquímiques.

Amb un model d'aquestes caracterítiques es podria tenir una valoració objectiva per conèixer la qualitat sense haver de recórrer a catadors. Tanmateix, es tindria informació de com modificar les seves propietats per millorar el vi. 

Aquest conjunt de dades constitueix una mostra de vins de denominació d'origen *Vinho Verde*. Per tant, de totes les observacions s'esperen una tendència semblant en les seves característiques; si més no, podem assumir que la qualitat s'haurà avaluat considerant els mateixos aspectes, propietats que s'esperaria trobar en el tast. Així doncs, la mostra pot ser una bona candidata per construir un model de predicció.

# Integració i selecció de les dades d'interès a analitzar

Les dades que disposem estan ja integrades en un únic fitxer en format *CSV*. Per procedir amb la neteja i anàlisi de les dades, les carreguem amb la funció `read.csv` de manera que les tindrem totes elles incloses en un dataframe.

```{r}
idata <- read.csv("../data/winequality-red.csv",header=TRUE)
summary(idata)
```

Cridant la funció `summary` per obtenir un resum de les columnes que constitueixen el dataframe, podem observar totes les variables que esperavem tenir al conjunt de dades: 11 variables quantitatives indicant propietats fisicoquímiques de les observacions de la mostra, i una altra variable quantitativa amb la valoració sensorial. A més a més, comprovem que totes elles estan identificades adequadament amb els noms assignats.

Excepte *quality*, que com hem vist és la variable objectiu en el nostre estudi, la resta són atributs que caracteritzen diferents aspectes dels vins avaluats, i a priori tots ells són susceptibles a ser útils en l'anàlisi. Per altra banda, el tamany de la mostra (1599 observacions) no és desmesurat i es podrà procesar sense dificultats. Així que inicialment seleccionem totes les dades que tenim ja carregades en el dataframe.

# Neteja de les dades

## Tractament de zeros o elements buits

```{r}
sapply(idata, class)
```

Podem comprovar que totes les variables carregades del *CSV* s'han reconegut com a numèriques (o integer). Això vol dir que no hi ha cap valor de tipus caràcter que s'hagi establert com a centinela per indicar element buit, perque llavors s'hauria fixat el tipus de dades com factor. També podriem haver arribat a aquesta mateixa conclusió directament observant el resum que vam mostrar anteriorment: en totes les variables es mostra un resum format per mitja i el sumari dels cinc números de Tukey, propi de les dades del tipus numèric. 

Per altra banda, si els elements buits s'haguèssin indicat amb espais buits ("") en el fitxer *CSV*, s'haurien traduït com "NA" (valors perduts) i aquests estarien registrats en el sumari anterior. Tampoc és el cas.

Per últim, hi ha la possibilitat que s'haguès fixat com a centinela el zero o algun valor sense sentit com podria ser en aquests atributs un número negatiu. En el sumari observem que els rangs dinàmics de les variables són inicialment coherents i només *citric.acid* conté zeros. A continuació mostrem l'histograma d'aquesta variable, on podem comprovar que aquest zeros no semblen ser valors extrems. Tanmateix, és factible que un vi tingui una concentració d'àcid cítric de 0 g/l [@Catania:2007], així que descartem que aquests zeros signifiquin ausència de valor.

```{r}
histogram(idata$citric.acid,nint=40,col='forestgreen')
```


## Valors extrems

En el sumari mostrat anteriorment es pot apreciar una distància entre el tercer quartil i el màxim més gran que en la resta de mesures en la majoria de variables. Això ja ens indica la presència de valors extrems o *outliers* en les nostres dades.

Basant-nos en el mètode de Turkey, podem identificar possibles outliers en el diagrama de caixa o directament amb la funció `r "boxplot.stats"` de R. A continuació analitzem en aquest aspecte cadascuna de les variables quantitatives.

**fixed acidity**

```{r}
boxplot.stats(idata$fixed.acidity)$out
```
Resulta que 49 valors són detectats com valors atípics. Però si representen la distribució de la variable observem que té una cua que s'extèn cap a aquests valors de manera que no semblen ser incongruents amb la resta de valors. 

```{r}
histogram(idata$fixed.acidity,nint=30,col='forestgreen')
```

Considerem que són valors atípics propis de la distribució.

**volatile acidity**

```{r}
length(boxplot.stats(idata$volatile.acidity)$out)
#boxplot(idata$volatile.acidity~idata$quality,col="forestgreen",cex.axis=0.7)
histogram(idata$volatile.acidity,nint=30,col='forestgreen')
```

Anàlogament al cas de l'acidesa fixa, considerem aquests outliers propis de la distribució.

**citric acid**

```{r}
boxplot.stats(idata$citric.acid)$out
```

En l'histograma representat en l'apartat de *Tractament de zeros* comprovem que la distribució es concentra en els valors esperats per la concentració d'àcid cítric inclosos en el rang [0.1,0.3] gr/l. Tanmateix es veu una cua que s'allarga cap a valors més alts de manera natural, però el valor detectat com outlier no s'oberva integrat en aquesta cua. Podria ser un valor atípic propi de la dsitribució, però la seva localització aïllada ens fa sospitar que no sigui legítim. El marquem com valor perdut per ser tractat posteriorment.

```{r}
idata$citric.acid[which(idata$citric.acid==max(idata$citric.acid))] <- NA
```

**residual sugar**

```{r}
length(boxplot.stats(idata$residual.sugar)$out)
histogram(idata$residual.sugar,nint=30,col='forestgreen')
```

En el cas de *residual sugar* ens trobem inicialment amb un número gens despreciable d'outliers: 155. En l'histograma es veuen com valors molt allunyats de la resta de observacions, i per tant són candidats a considerar-los valors atípics contaminants i ser tractats com a tal. Però tal com vam descriure en el primer apartat, el vi pot tenir concentracions de sucre molt divers, trobant concentracions fins a 18 g/l pel tipus semisec. És a dir, els valors que tenim aqui com candidats a valors extrems il·legítims són valors totalment pausibles. Que apareguin en la distribució com outliers pot ser degut a que aquesta mostra pertany a la població de vins d'una denominació d'origen específica, de la qual probablement la producció s'especialitza més en vins més secs. Llavors concluïm que aquests valors atípics són propis de la distribució de la variable.

**chlorides**

```{r}
length(boxplot.stats(idata$chlorides)$out)
histogram(idata$chlorides,nint=30,col='forestgreen')
```

En el cas dels *chlorides* també tenim un número important d'outliers: 112. Observem que aquests estam molt dispersats arribant a un valor de ~0.6 gr/l, però hi ha certa continuïtat en la distribució. Tanmateix, els valors de concentració de clorurs en el vi poden ser generalment fins a valors de 0.5 g/l, arribant a valors de 1 g/l per vinyes situades ubicades a prop del mar [@Enrique]. La mostra que estem analitzant inclou vins de D.O. "Vinho Verde", i aquests es cultiven en una regió amb costa [@wikiVinhoVerde]; per tant, pot haver-hi perfectament en la mostra individus amb aquestes concentracions. 

**free sulfur dioxide**

```{r}
boxplot.stats(idata$free.sulfur.dioxide)$out
histogram(idata$free.sulfur.dioxide,nint=30,col='forestgreen')
```

En la variable *free sulfur dioxide* es detecten `r length(boxplot.stats(idata$free.sulfur.dioxide)$out)` outliers. En l'histograma veiem que la gran majoria d'aquests segueixen la cua allargada de la distribució, però hi ha un petit conjunt aïllat en els valors més alts. Procedim a considerar-los com valors atípcs contaminants i els marquem com valors perduts.

```{r}
idata$free.sulfur.dioxide[which(idata$free.sulfur.dioxide > 60)] <- NA
```


**total sulfur dioxide**

```{r}
boxplot.stats(idata$total.sulfur.dioxide)$out
histogram(idata$total.sulfur.dioxide,nint=30,col='forestgreen')
```

La gran majoria d'outliers detectats es poden considerar valors propis de la distribució que tenim tal com s'observa en l'histograma. Però hi ha alguns valors allunyats els quals sobre passen el límit que es considera legal en concentracions d'anhídrid sulfuròs. Això ens fa pensar que es tractin de valors atípics contaminants, i per tant, els marquem com valors perduts.

```{r}
idata$total.sulfur.dioxide[which(idata$total.sulfur.dioxide > 200)] <- NA
```

**density**

```{r}
boxplot.stats(idata$density)$out
histogram(idata$density,nint=30,col='forestgreen')
```

Malgrat que inicialment es detecten outliers, amb la visualització de l'histograma podem considerar que aquests formen part de la distribució coherentment i els considerarem legítims. No prendrem mesures per corregir-los.

**pH**

```{r}
boxplot.stats(idata$pH)$out
histogram(idata$pH,nint=30,col='forestgreen')
```

En el cas de *pH*, del conjunt d'outliers podriem sospitar dels localitzats a valors més grans, però són valors que es troben normalment en el vi [@Enrique], així que suposarem que són tots legítims.

**sulphates**

```{r}
boxplot.stats(idata$sulphates)$out
histogram(idata$sulphates,nint=30,col='forestgreen')
```

*sulphates* presenta una cua en la distribució que s'allunya a valors alts. Els primers valors mostren continuïtat en l'histograma, però hi ha alguns >1.5 que són sospitosos. La quantitat de sulfats en vins normals és de l'ordre de 0.6-0.7 g/l, arribant a ser 2 g/l. en vins envellits [@Enrique]. Però els de D.O. *Vinho Verde* es caracteritzen per ser joves [@wikiVinhoVerde]; per tant, es confirma que aquests valors són probablement contaminants. Considerarem valors perduts a partir de 1.5.

```{r}
idata$sulphates[which(idata$sulphates > 1.5)] <- NA
```

**alcohol**

```{r}
length(boxplot.stats(idata$alcohol)$out)
histogram(idata$alcohol,nint=30,col='forestgreen')
```

**quality**

Finalment, pel que fa a la variable de qualitat, tots els valors estan dins del rang com vam veure en el sumari de l'apartat d' *Integració*, així que no hi ha motius per considerar que hi hagin valors atípics.

```{r}
nacount<-apply(idata, 1, function(x) sum(is.na(x)))
sum(nacount)
max(nacount)
```

Una vegada determinats els valors atípics contaminants, i per tant marcats con valors perduts, hem de tractar-los. Les opcions que tenim són:

* Descartar les observacions que tenen algun valor perdut. En el nostre cas, tenim un total de 15 registres afectats, amb un màxim de 2 NA per registre. Malgrat que només suposaria <1% de les dades, perderiem informació ja que els registres tenen molt pocs valors perduts. 

* Fer servir un mètode d'imputació de valors. Podem assignar valors de tendència central de la variable en qüestió, dins de la mostra o considerant només les observacions de la mateixa categoria (qualificació de qualitat). O bé, fer servir que mesuri similitud entre observacions de la mostra, que degut als objectius fixats en l'anàlisi i les característiques de les dades, es pot considerar més adient.

Decidim aplicar aquesta segona opció, i per aquesta finalitat farem servir la imputació kNN. Fem servir la comanda `kNN` de la llibreria `VIM`, amb els paràmetres per defecte.

```{r}
odata<-kNN(idata,imp_var=FALSE)
```


# Anàlisis de les dades

## Selecció dels grups de dades


(Formar conjunts de test i prova)

## Comprovació de la normalitat i homogeneïtat de la variància

http://www.dummies.com/programming/r/how-to-test-data-normality-in-a-formal-way-in-r/

http://www.cookbook-r.com/Statistical_analysis/Homogeneity_of_variance/

## Correlació entre variables

## Diferències significatives en les variables segons la qualitat del vi

## Proves estadístiques

(Regressió lineal multivariant)

# Representació dels resultats

# Conclusions

# References

